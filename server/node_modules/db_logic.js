/**
 * Created by bcouriol on 15/09/14.
 */

/**
 * Use deferred because pgClient stuff can only be done aftre pgClient is non null
 * @type {exports}
 */

var LOG = require('debug');
var
   pg,
   pgClient = null, // database connection variables
   important_words = null; // list of requent words as returned by query

const conString = "postgres://postgres:Italska184a@localhost/postgres"; // connection string

function initialize_database () {
  pg = require('pg');
  pgClient = new pg.Client(conString);
  pgClient.connect(function (err) {
    if (err) {
      console.error('could not connect to postgres', err);
      return null;
    }
    exec_qry_freq_word_list(); // that updates important_words
  });
}

function close_connection () {
  pgClient.end();
}

function exec_qry_freq_word_list () {
  pgClient.query("select string_agg(word, ' | ') as freq_words from pgWordFrequency where freq_cat = 'A';",
                 function (err, result) {
                   if (err) {
                     console.error('error running query', err);
                     return null;
                   }
                   important_words = result.rows[0].freq_words;
                   //output: Tue Jan 15 2013 19:12:47 GMT-600 (CST)
                 });
}

function get_db_client () {
  return pgClient;
}

function get_important_words () {
  return important_words;
}

module.exports = {
  initialize_database: initialize_database,
  close_connection   : close_connection,
  get_important_words: get_important_words,
  get_db_client      : get_db_client
};
